Phoenix.ImageViewer=Phoenix.ImageViewer||{};(function(App){"use strict";App.Models=App.Models||{};App.Models.Image=Backbone.Model.extend({defaults:{original:"/bundles/phoenixsite/images/core/loose/no-image-30x30.png"},initialize:function(){if(!this.get("src")){this.set({src:this.defaults.title})}}});App.Models.Comment=Backbone.Model.extend({defaults:{avatar:"/bundles/phoenixsite/images/core/loose/no-image-30x30.png"},initialize:function(){if(!this.get("avatar")){this.set({avatar:this.defaults.title})}}})})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Collections=App.Collections||{};App.Collections.Images=Backbone.Collection.extend({model:App.Models.Image,parse:function(response,xhr){return response.images},initialize:function(){this.on("add",function(model){if(!model.id){throw new Error("Invalid model data.")}})}});App.Collections.Comments=Backbone.Collection.extend({model:App.Models.Comment})})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Views=App.Views||{};App.Views.Mixins={loadResults:function(App,callbacks){var self=this;callbacks=callbacks||{};if(!this.loadingResults){this.loadingResults=true;this.collection.fetch({url:App.fetchUrl,add:true,data:{images:App.imageIds,start:App.startingIndex+=App.requestThreshold,count:App.requestThreshold,object:App.objectId||""},success:function(collection,response){self.loadingResults=false;if(callbacks.success){callbacks.success.call(self,response)}},error:function(jqXhr,textStatus,errorThrown){self.loadingResults=false},complete:function(){if(callbacks.complete){callbacks.complete.call(self)}}})}}}})(Phoenix.ImageViewer||{});
(function(App){"use strict";var $doc=Phoenix.getDocument();App.Views.Viewer=Backbone.View.extend(_.extend({},App.Views.Mixins,{el:Phoenix.jQuery.getBody(),els:{},collectionIndex:0,viewerOpen:false,viewerMode:"",gutterSize:0,btnSize:120,thumbSize:150,imageIds:"",objectId:"",activeGuid:null,startingIndex:0,requestThreshold:30,windowWidth:null,windowHeight:null,paneWidth:null,paneHeight:null,commentUrl:null,viewerEnabled:true,entryUrl:"",isPhone:false,currentFetch:null,commandsTipCookieKey:"image_commands_tip_hidden",commandsTipFadeOutDelay:4e3,commandsTipHideDelay:2e3,commandsTipTimeout:null,events:{"click #js-image-close":"closeViewer","click #js-image-prev":"prevImage","click #js-image-next":"nextImage","click #js-image-pane":"nextImage","click #js-image-view-film":"toggleFilmStrip","click #js-image-fs":"toggleFullscreen","click #wrapper figure a":"loadFromEmbed"},initialize:function(){var self=this;this.setEls().setStage();this.entryUrl=window.location.pathname+window.location.search;var device=$('meta[itemprop="deviceType"]').attr("content");if(device==="phone"){this.isPhone=true}this.initializeCollection();if(this.isPhone){return}this.commentPoster=new App.Views.CommentPoster({});Phoenix.jQuery.getWindow().on({resize:$.proxy(this.setStage,this),keyup:$.proxy(this.keypressHandler,this)});this.els.$sideColumn.on("click","a",function(e){self.stopEvent(e);self.closeViewer(e,true);window.location.href=e.target.href})},initializeCollection:function(){var self=this;if(this.currentFetch!==null){this.currentFetch.abort()}var galleryMarker=Phoenix.jQuery.getWrapper().find("#galleryMarker");this.viewerMode=galleryMarker.data("mode")?galleryMarker.data("mode"):"adHoc";this.requestThreshold=this.calculateThreshold();var cdnHost=$("meta[itemprop=cdnHost]").attr("content");this.fetchUrl="/js/image-data.json";if(this.viewerMode==="gallery"){this.imageIds=galleryMarker.data("galleryId");this.objectId=galleryMarker.data("objectId");window.onbeforeunload=function(event){self.closeViewer(event,true)}}else if(this.viewerMode==="permalink"){this.fetchUrl=cdnHost+this.fetchUrl;this.imageIds=galleryMarker.data("refId");$("#js-image-close").hide()}else if(this.viewerMode==="adHoc"){var imageArray=Phoenix.jQuery.getWrapper().find("figure a[data-ref-id]").map(function(){return this.getAttribute("data-ref-id")}).get();if(imageArray.length>=300){this.destroyCollection();this.disableViewer();$("figure a").click(function(e){e.preventDefault();if($(this).attr("href").length>0){window.open($(this).attr("href").replace("square_avatar","original"),"_blank")}return false})}this.fetchUrl=cdnHost+this.fetchUrl;this.imageIds=imageArray.join(",");window.onbeforeunload=function(event){self.closeViewer(event,true)};$doc.on("image-viewer-rescrape",function(event){var newIds=Phoenix.jQuery.getWrapper().find("figure a[data-ref-id]").map(function(){return this.getAttribute("data-ref-id")});var oldImages=self.imageIds.split(",");var imagesToLoad=_.difference(newIds,oldImages);self.imageIds=imagesToLoad.join(",");self.loadResults(App.App);self.imageIds=_.union(oldImages,imagesToLoad).join(",")})}if(this.imageIds===""){return}this.currentFetch=this.collection.fetch({url:this.fetchUrl,data:{images:this.imageIds,start:this.startingIndex,count:this.requestThreshold,object:this.objectId},success:function(){Phoenix.jQuery.getWindow().trigger("collectionLoaded");if(self.collection.length>0){self.commentUrl=self.collection.at(0).get("addCommentUrl")}},error:function(jqxhr,textStatus,errorThrown){if(textStatus==="timeout"){}}})},destroyCollection:function(){this.startingIndex=0;this.collection.reset()},disableViewer:function(){this.viewerEnabled=false},enableViewer:function(){this.viewerEnabled=true},render:function(id){if(this.isPhone){return}if(!this.viewerOpen){$doc.trigger("render_page_event",["image_view"])}this.activeGuid=id;var model=this.collection.get(id);this.imageView=new App.Views.ImageView({model:model});this.titleBar=new App.Views.TitleBar({model:model});this.info=new App.Views.InfoBar({model:model});if(this.collection.length>1&&!this.filmstrip){this.filmstrip=new App.Views.Filmstrip({collection:this.collection})}this.togglePaginationVisibility();if(!this.viewerOpen){this.els.$viewer.addClass("filmstripOpen");if(this.shouldShowCommandsTip()){this.toggleCommandsTip("show")}Phoenix.jQuery.getHtml().css("overflow-y","hidden");this.viewerOpen=true}return this},calculateThreshold:function(){if(this.viewerMode==="adHoc"){return-1}if(this.isPhone){return 5}return Math.floor(this.windowWidth/this.thumbSize)*Math.ceil(this.stripHeight/this.thumbSize)},keypressHandler:function(e){if(!this.viewerOpen){return}var codes=Phoenix.Core.keycodes;if(this.$el.data("filmstripOpen")){switch(e.which){case codes.rightArrow:this.filmstrip.moveHighlight("right");break;case codes.leftArrow:this.filmstrip.moveHighlight("left");break;case codes.downArrow:this.filmstrip.moveHighlight("down");break;case codes.upArrow:this.filmstrip.moveHighlight("up");break;case codes.escapeKey:this.toggleFilmStrip();break;case codes.enterKey:this.filmstrip.showImage(e);break}}else{switch(e.which){case codes.escapeKey:this.closeViewer();break;case codes.rightArrow:this.nextImage();break;case codes.leftArrow:this.prevImage();break;case codes.upArrow:this.toggleFilmStrip();break}}return this},closeViewer:function(event,force){if(!this.viewerOpen){return}if(this.viewerMode==="permalink"&&!force){return false}$doc.trigger("remove_page_event",["image_view"]);this.els.$viewer.removeClass("filmstripOpen");if(this.isCommandsTipOpen()!==false){this.toggleCommandsTip("hide")}Phoenix.jQuery.getHtml().css("overflow-y","scroll");this.resetUrl();this.viewerOpen=false;return this},resetUrl:function(){App.Routers.AppRouter.navigate(this.entryUrl);return this},prevImage:function(e){this.stopEvent(e);if(this.collectionIndex===0){return false}this.collectionIndex--;this.setUrlHash();return this},nextImage:function(e){this.stopEvent(e);if(this.collectionIndex>=this.collection.length-3){this.loadMoreImages()}if(this.collectionIndex===this.collection.length-1){return false}this.collectionIndex++;this.setUrlHash();return this},loadMoreImages:function(callback){if(this.viewerMode!=="gallery"){return}this.loadResults(App.App,{complete:function(){if(callback){callback()}}})},setUrlHash:function(id){var viewerOpen=this.viewerOpen;if(!viewerOpen){$doc.trigger("render_page_event",["image_view",true])}else{$doc.trigger("update_page_event",["image_view"])}id=id||this.collection.at(this.collectionIndex).id;App.Routers.AppRouter.navigate("images/"+id,{trigger:true,replace:viewerOpen});return this},loadImage:function(id){this.collectionIndex=_.indexOf(this.collection.models,this.collection.get(id));if(this.collectionIndex===-1){Phoenix.Ui.showErrorMessage("Error loading image viewer: invalid model data.");this.resetUrl();throw new Error("Model not set.")}this.render(id);return this},loadFromEmbed:function(e){if(!this.viewerEnabled){return}var id=$(e.currentTarget).data("refId");if(id){this.stopEvent(e).setUrlHash(id)}return this},showFilmStrip:function(){this.els.$viewer.addClass("imageStripOpen");this.els.$imageBtnIcon.toggleClass("icon-caret-up icon-caret-down");this.$el.data("filmstripOpen",true);return this},hideFilmStrip:function(){this.els.$viewer.removeClass("imageStripOpen");this.els.$imageBtnIcon.toggleClass("icon-caret-up icon-caret-down");this.$el.data("filmstripOpen",false);return this},toggleFilmStrip:function(e){this.stopEvent(e);if(this.$el.data("filmstripOpen")){this.hideFilmStrip()}else{this.showFilmStrip();this.filmstrip.render.call(this.filmstrip,null,this.collectionIndex)}},stopEvent:function(e){if(e){e.preventDefault();e.stopPropagation()}return this},togglePaginationVisibility:function(){if(this.collection.length===1){return false}else if(this.collectionIndex===0){this.els.$imageNext.removeClass("hidden");this.els.$imagePrev.addClass("hidden")}else if(this.collectionIndex===this.collection.length-1){this.els.$imageNext.addClass("hidden");this.els.$imagePrev.removeClass("hidden")}else{this.els.$imageNext.removeClass("hidden");this.els.$imagePrev.removeClass("hidden")}return this},setEls:function(){var els=this.els,el=els.$viewer=$("#js-filmstrip");els.$imageBtnIcon=el.find("#js-btn-icon");els.$imagePane=el.find("#js-image-pane");els.$sideColumn=el.find("#js-side-column");els.$imagePrev=el.find("#js-image-prev");els.$imageNext=el.find("#js-image-next");els.$imageSource=el.find("#imageSource");els.$filmstripTab=el.find("#js-image-view-film");els.$imageStrip=el.find("#js-image-strip");els.$adLeader=el.find("#js-image-ad-leader");els.$commandsTip=el.find("#js-image-commands-tip");els.$imageClose=el.find("#js-image-close");return this},setStage:function(){var els=this.els;this.windowWidth=Phoenix.jQuery.getWindow().width();this.windowHeight=Phoenix.jQuery.getWindow().height();this.stripHeight=Math.floor(this.windowHeight*.5*.95);var withoutStripHeight=this.windowHeight-els.$adLeader.height(),i=null,sameHeight=[els.$sideColumn];var fullscreen=$("#js-image-fs").data("fullscreen");var gutterSpace=3*this.gutterSize;this.paneWidth=this.windowWidth-els.$sideColumn.width()-10;this.paneHeight=withoutStripHeight;els.$sideColumn.css({top:els.$adLeader.outerHeight()});els.$imagePane.css({width:this.paneWidth,height:this.paneHeight});els.$imageClose.css({top:els.$adLeader.outerHeight()+40,right:els.$sideColumn.width()+40});for(i=0;i<sameHeight.length;i++){sameHeight[i].height(withoutStripHeight)}this.centerFilmstripTab();this.imageStripRowSize=Math.floor(this.windowWidth/this.thumbSize);if(this.imageView){this.imageView.centerImage()}return this},centerFilmstripTab:function(){this.els.$filmstripTab.css({left:this.paneWidth/2-this.btnSize/2});return this},toggleFullscreen:function(mode){var toggler=$("#js-image-fs");if(toggler.data("fullscreen")){this.closeFullscreen();$.cookie("image-viewer-fullscreen",false)}else{this.openFullscreen();$.cookie("image-viewer-fullscreen",true)}return false},openFullscreen:function(){var toggler=$("#js-image-fs");if(toggler.data("fullscreen")){return}toggler.data("cachedSideColWidth",this.els.$sideColumn.width());toggler.data("cachedMainColWidth",this.els.$imagePane.width());this.paneWidth=Phoenix.jQuery.getWindow().width();this.els.$sideColumn.width("0");this.els.$imagePane.width(this.paneWidth);this.els.$imageClose.css({right:40});this.centerFilmstripTab();this.imageView.centerImage();this.isFullscreen=true;toggler.data("fullscreen",true)},closeFullscreen:function(){var toggler=$("#js-image-fs");if(!toggler.data("fullscreen")){return}var sideColumnWidth=toggler.data("cachedSideColWidth");this.els.$sideColumn.width(sideColumnWidth);this.paneWidth=this.windowWidth-sideColumnWidth;this.els.$imagePane.css({width:this.paneWidth,height:this.paneHeight});this.els.$imageClose.css({right:sideColumnWidth+40});this.centerFilmstripTab();this.imageView.centerImage();toggler.data("fullscreen",false);this.isFullscreen=false},isCommandsTipOpen:function(){var tip=this.els.$commandsTip;if(tip.hasClass("image-commands-tip-fade-out")){return"fadedOut"}else if(tip.hasClass("image-commands-tip-hide")){return false}else{return true}},shouldShowCommandsTip:function(){if(!$.cookie(this.commandsTipCookieKey)){$.cookie(this.commandsTipCookieKey,"1",{expires:30,path:"/"});return true}else{if(this.isCommandsTipOpen()){this.toggleCommandsTip("hide")}return false}},toggleCommandsTip:function(mode){var self=this;switch(mode){case"show":if(this.commandsTipTimeout!==null){window.clearTimeout(this.commandsTipTimeout);this.commandsTipTimeout=null}if(this.isCommandsTipOpen()!==true){this.els.$commandsTip.removeClass("image-commands-tip-fade-out image-commands-tip-hide")}this.commandsTipTimeout=window.setTimeout(function(){self.toggleCommandsTip("fadeOut")},this.commandsTipFadeOutDelay);break;case"fadeOut":if(this.isCommandsTipOpen()===true){this.els.$commandsTip.addClass("image-commands-tip-fade-out");this.commandsTipTimeout=window.setTimeout(function(){self.toggleCommandsTip("hide")},this.commandsTipHideDelay)}break;default:if(this.isCommandsTipOpen()!==false){if(this.commandsTipTimeout!==null){window.clearTimeout(this.commandsTipTimeout);this.commandsTipTimeout=null}this.els.$commandsTip.addClass("image-commands-tip-hide").removeClass("image-commands-tip-fade-out")}}}}))})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Views.TitleBar=Backbone.View.extend({el:$("#js-image-title"),initialize:function(){this.render()},render:function(){this.$el.html(this.model.get("caption"));return this}})})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Views.InfoBar=Backbone.View.extend({el:$("#imageInfo"),template:_.template($("#imageInfoBarTemplate").html()),initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}})})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Views.ImageView=Backbone.View.extend({el:$("#imageSource"),imagePane:$("#js-image-pane"),loader:null,initialize:function(){this.paneHeight=App.App.paneHeight;this.paneWidth=App.App.paneWidth;this.oldPaneHeight=this.paneHeight;this.oldPaneWidth=this.paneWidth;this.imageHeight=this.model.get("height");this.imageWidth=this.model.get("width");this.realImageHeight=this.model.get("height");this.realImageWidth=this.model.get("width");this.imageHeight=null;this.imageWidth=null;if(this.imageHeight===null){var image=new Image;image.src=this.model.get("original");var model=this;var self=this;image.onload=function(){model.imageHeight=this.height;model.imageWidth=this.width;model.realImageHeight=this.height;model.realImageWidth=this.width;self.model.set("height",this.height);self.model.set("width",this.width);model.resetImageSize();self.centerImage()}}this.model.on("change:height",function(){this.imageHeight=this.model.get("height")},this);this.model.on("change:width",function(){this.imageWidth=this.model.get("width")},this);this.clearImage();this.$el.fadeOut("fast",$.proxy(this.render,this))},checkDimensions:function(){if(this.realImageWidth<=App.App.paneWidth&&this.realImageHeight<=App.App.paneHeight){this.resetImageSize();return}if(App.App.paneWidth>0&&this.imageWidth===0)this.imageWidth=1;if(App.App.paneHeight>0&&this.imageHeight===0)this.imageHeight=1;if(this.oldPaneWidth!=App.App.paneWidth||this.imageWidth>App.App.paneWidth){this.adjustWidth()}if(this.oldPaneHeight!=App.App.paneHeight||this.imageHeight>App.App.paneHeight){this.adjustHeight()}this.oldPaneWidth=App.App.paneWidth;this.oldPaneHeight=App.App.paneHeight},adjustWidth:function(){this.model.set({width:App.App.paneWidth,height:Math.round(this.realImageHeight/this.realImageWidth*App.App.paneWidth)})},adjustHeight:function(){this.model.set({width:Math.round(this.imageWidth/this.imageHeight*App.App.paneHeight),height:App.App.paneHeight})},resetImageSize:function(){this.model.set({width:this.realImageWidth,height:this.realImageHeight})},resetWidth:function(){this.model.set({width:this.realImageWidth})},resetHeight:function(){this.model.set({height:this.realImageHeight})},render:function(){Phoenix.getDocument().trigger("pre_page_event",["image_view"]);var self=this,el=this.$el,url=this.model.get("scale_super");this.imagePane.addClass("loading");this.loader=$("<img />");this.loader.on("load",function(){el.css({height:self.imageHeight,width:self.imageWidth}).attr("src",url);self.centerImage().imagePane.removeClass("loading");el.fadeIn("fast");var comments=self.model.get("comments");if(!comments){var commentUrl=self.model.get("getCommentsUrl");$.ajax({url:commentUrl,data:{guid:self.model.get("id")},success:function(data){if(data.success){var comments=data.data;self.model.set("comments",comments);App.App.comments=new App.Views.Comments({collection:new App.Collections.Comments(comments)})}}})}}).on("error",function(){Phoenix.Ui.showErrorMessage("Error loading image. Please try another.")});this.loader.attr("src",url);Phoenix.getDocument().trigger("on_page_event",["image_view"]);$(window).trigger("resize");return this},centerImage:function(callback){this.checkDimensions();this.$el.css({width:this.imageWidth,height:this.imageHeight,top:this.imageHeight>=App.App.paneHeight?0:(App.App.paneHeight-this.imageHeight)/2,left:this.imageWidth>=App.App.paneWidth?0:(App.App.paneWidth-this.imageWidth)/2});if(callback){callback.call(this)}return this},clearImage:function(){this.$el.attr("src","");Phoenix.getDocument().trigger("post_page_event",["image_view"])}})})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Views.FilmstripItem=Backbone.View.extend({el:$("#js-image-strip"),template:_.template($("#imageFilmstripTemplate").html()),initialize:function(){this.model.on("change",this.render,this)},render:function(){return this.template(this.model.toJSON())}})})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Views.Filmstrip=Backbone.View.extend(_.extend({},App.Views.Mixins,{el:$("#js-image-strip"),loadMore:$("#js-image-strip-load-more"),highlightedClass:"imgboxart",scrollThreshold:100,throttledLazyLoad:null,built:false,events:{"click #js-image-strip-load-more":"loadMoreImages","click a":"showImage",scroll:"checkScroll"},initialize:function(){this.collection.on("reset",function(event){this.built=false;this.collection.models=event.models;this.clearImages()},this).on("add",function(image){console.log("add");this.addImage(image)},this);this.$el.closest(".image-strip").addClass("imagestripActive");this.isLoading=false;this.throttledLazyLoad=_.throttle(this.loadVisibleImages,100);this.$el.contents().filter(function(){return this.nodeType===3}).remove()},render:function(models,itemIndex){if(this.built){this.scrollToIndex(itemIndex);this.loadVisibleImages();this.highlight(itemIndex);return false}models=models||this.collection.models;_.each(models,function(image){this.addImage(image)},this);if(itemIndex){this.scrollToIndex(itemIndex)}this.loadVisibleImages();if(itemIndex){this.highlight(itemIndex)}this.built=true;return this},scrollToIndex:function(itemIndex){var selectedItem=this.$el.find("li:eq("+itemIndex+")");var selectedItemTop=selectedItem.position().top+this.$el.scrollTop();this.$el.scrollTop(selectedItemTop)},showImage:function(e){e.preventDefault();e.stopPropagation();var Viewer=App.App,refId=null;var itemClicked=null;if(e.which===Phoenix.Core.keycodes.enterKey){itemClicked=this.$el.find("li ."+this.highlightedClass).parents("li").first();if(itemClicked.attr("id")==="js-image-strip-load-more"){this.loadMoreImages();return}refId=itemClicked.find("a").attr("data-ref-id")}else{itemClicked=$(e.target);refId=itemClicked.attr("data-ref-id");itemClicked=itemClicked.parent()}var numberOfItems=this.$el.find("li").length;var itemIndex=this.$el.find("li").index(itemClicked[0]);if(itemIndex+5>numberOfItems){Viewer.filmstrip.loadMoreImages()}Viewer.setUrlHash(refId).toggleFilmStrip()},clearImages:function(){this.$el.children().remove()},addImage:function(image){var filmstripItem=$(new App.Views.FilmstripItem({model:image}).render());filmstripItem.contents().filter(function(){return this.nodeType===3}).remove();this.$el.append(filmstripItem);this.loadMore.remove();this.$el.append(this.loadMore)},highlight:function(index){this.$el.find("li a."+this.highlightedClass).removeClass(this.highlightedClass).end().find("li:eq("+index+") a").addClass(this.highlightedClass)},moveHighlight:function(where){var lis=this.$el.find("li"),self=this,current=lis.filter(function(){return $(this).find("a."+self.highlightedClass).length>0}),currentIndex=current.index(),move=function(index){current.find("a").removeClass();var item=lis.eq(index);item.find("a").addClass(self.highlightedClass);if(index+5>lis.length){self.loadMoreImages()}var containerScrollTop=self.$el.scrollTop();var top=item.position().top;var bottom=top+containerScrollTop+item.outerHeight();var containerBottom=containerScrollTop+self.$el.outerHeight();if(bottom>containerBottom){var diff=bottom-containerBottom+20;self.$el.animate({scrollTop:containerScrollTop+diff},1e3)}else if(top<0){self.$el.animate({scrollTop:containerScrollTop+top-20},1e3)}};var margin=lis.first().position().left;var containerWidth=this.$el.outerWidth();var itemWidth=lis.first().outerWidth(true);var itemsPerRow=Math.floor((containerWidth-2*margin)/itemWidth);if(where==="right"){if(currentIndex===lis.length-2){return false}move(currentIndex+1)}else if(where==="up"){if(currentIndex===0){return false}var newIndex=currentIndex-itemsPerRow;if(newIndex<0){newIndex=0}move(newIndex)}else if(where==="down"){if(currentIndex===lis.length-2){return false}var newIndex=currentIndex+itemsPerRow;if(newIndex>lis.length-2){newIndex=lis.length-2}move(newIndex)}else if(where==="left"){if(currentIndex===0){return false}move(currentIndex-1)}},checkScroll:function(){var self=this;if(this.el.scrollTop+this.el.clientHeight+this.scrollThreshold>this.el.scrollHeight){this.loadResults(App.App,{success:self.loadVisibleImages})}this.throttledLazyLoad()},loadMoreImages:function(){this.loadResults(App.App,{success:this.loadVisibleImages});this.throttledLazyLoad()},loadVisibleImages:function(){App.App.stripHeight=App.App.els.$viewer.find("#js-image-strip").height();if(this.loadingVisible){return false}this.loadingVisible=true;this.$el.find("img[data-img-src]").each(function(){var $img=$(this),imgTop=Math.round($img.closest("li").position().top);if(imgTop>=0&&imgTop<=App.App.stripHeight&&$img.data("imgSrc")){$("<img />").on("load",function(){$img.attr("src",$img.data("imgSrc")).addClass("loaded").removeAttr("data-img-src")}).attr("src",$img.data("imgSrc"))}});this.loadingVisible=false}}))})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Views.Comments=Backbone.View.extend({el:$("#imageComments"),template:_.template($("#imageCommentsTemplate").html()),initialize:function(){this.$el.empty();this.render()},render:function(){_.each(this.collection.models,function(item){this.add(item.toJSON())},this);return this},add:function(comment){if(!comment){Phoenix.Ui.showErrorMessage("Error posting comment, please try again later.");return false}this.$el.append(this.template(comment));return true}})})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Views.CommentPoster=Backbone.View.extend({el:$("#imageCommentPoster"),posting:false,initialize:function(){var self=this;this.$el.find("#postComment").on("click",function(e){e.preventDefault();e.stopPropagation();if(self.posting){return}var msg=self.$el.find("#imageComment").val();self.posting=true;$.ajax({type:"POST",url:App.App.commentUrl,data:{guid:App.App.activeGuid,comment:msg},beforeSend:function(){},complete:function(){self.posting=false},success:function(comment){var success=App.App.comments.add(comment.data);if(!success){return}Phoenix.Ui.showSuccessMessage("Comment posted.");self.$el.find("#imageComment").val("");self.hideComments()},error:function(xhr,textStatus,errorThrown){Phoenix.Ui.showSuccessMessage("Error posting comment.")}})})},hideComments:function(){this.$el.parent().addClass("hide")},showComments:function(){this.$el.parent().removeClass("hide")}})})(Phoenix.ImageViewer||{});
(function(App){"use strict";App.Routers=App.Routers||{};App.Routers.ImageViewer=Backbone.Router.extend({routes:{"images/:id/":"loadImage","images/:id":"loadImage","*notFound":"closeViewer"},initialize:function(){App.App=new App.Views.Viewer({collection:new App.Collections.Images})},loadImage:function(id){App.App.loadImage(id);var device=$('meta[itemprop="deviceType"]').attr("content");if(device==="phone"){return}App.App.commentPoster.showComments();if($.cookie("image-viewer-fullscreen")==="true"){App.App.openFullscreen()}else{App.App.closeFullscreen()}},closeViewer:function(route){App.App.closeViewer()}})})(Phoenix.ImageViewer||{});$(function(App){"use strict";App.Routers.AppRouter=new App.Routers.ImageViewer;var historyStarted=false;Phoenix.jQuery.getWindow().on("collectionLoaded",function(){var device=$('meta[itemprop="deviceType"]').attr("content");if(!historyStarted&&device!=="phone"){if(!window.history.pushState){var hashLink=location.pathname;if(hashLink.indexOf("/images/")===0||hashLink.indexOf("images")===0){if(hashLink.indexOf("/")===0){hashLink=hashLink.substr(1)}location.hash=hashLink}Backbone.history.start({pushState:false,root:location.host+location.pathname})}else{Backbone.history.start({pushState:true})}historyStarted=true}})}(Phoenix.ImageViewer||{}));